<?php
// COMBINED: SSTI, JWT Advanced, ReDoS, HTTP Response Splitting
// Hidden Hint: Multiple advanced vulnerability types in report generator
session_start();
include("config-vulnerable.php");
error_reporting(E_ALL);
ini_set('display_errors', 1);

$output = "";

// VULNERABILITY #1: Server-Side Template Injection (SSTI)
// Hidden Hint: User input in template without escaping
if(isset($_POST['generate_report'])) {
    $patient_name = $_POST['patient_name'];
    $diagnosis = $_POST['diagnosis'];
    
    // SSTI: Using eval-like template processing
    // Hidden Hint: {{7*7}} in patient_name executes as code
    $template = "Patient Report: $patient_name - Diagnosis: $diagnosis";
    
    // Vulnerable template processing
    $template = str_replace('{{', '<?php echo ', $template);
    $template = str_replace('}}', '; ?>', $template);
    
    ob_start();
    eval('?>' . $template);
    $output = ob_get_clean();
}

// VULNERABILITY #2: JWT Advanced Attacks
// Hidden Hint: Multiple JWT vulnerabilities
if(isset($_POST['create_token'])) {
    $user_id = $_POST['user_id'];
    $role = isset($_POST['role']) ? $_POST['role'] : 'user';
    
    // JWT with weak secret
    $header = json_encode(['typ' => 'JWT', 'alg' => 'HS256']);
    $payload = json_encode(['user_id' => $user_id, 'role' => $role]);
    
    // VULNERABILITY: Weak secret
    $secret = 'secret123'; // Hidden Hint: Easy to brute force
    
    $base64UrlHeader = str_replace(['+', '/', '='], ['-', '_', ''], base64_encode($header));
    $base64UrlPayload = str_replace(['+', '/', '='], ['-', '_', ''], base64_encode($payload));
    
    $signature = hash_hmac('sha256', $base64UrlHeader . "." . $base64UrlPayload, $secret, true);
    $base64UrlSignature = str_replace(['+', '/', '='], ['-', '_', ''], base64_encode($signature));
    
    $jwt = $base64UrlHeader . "." . $base64UrlPayload . "." . $base64UrlSignature;
    $output = "JWT Token: " . $jwt;
}

// VULNERABILITY: JWT None Algorithm Attack
// Hidden Hint: Accepting "none" algorithm bypasses signature verification
if(isset($_POST['verify_token'])) {
    $token = $_POST['token'];
    $parts = explode('.', $token);
    
    if(count($parts) == 3) {
        $header = json_decode(base64_decode(str_replace(['-', '_'], ['+', '/'], $parts[0])), true);
        
        // VULNERABILITY: Accepts "none" algorithm
        if($header['alg'] == 'none') {
            // No signature verification!
            $output = "Token accepted without verification!";
        }
    }
}

// VULNERABILITY #3: ReDoS (Regular Expression Denial of Service)
// Hidden Hint: Evil regex patterns cause CPU exhaustion
if(isset($_POST['validate_input'])) {
    $input = $_POST['input'];
    
    // VULNERABLE REGEX: Catastrophic backtracking
    // Hidden Hint: Input like "aaaaaaaaaaaaaaaaaaaaaaaaaX" causes extreme delay
    $pattern = '/^(a+)+$/'; // Evil regex
    
    $start = microtime(true);
    preg_match($pattern, $input);
    $end = microtime(true);
    
    $time = ($end - $start) * 1000;
    $output = "Validation took: " . $time . "ms";
}

// VULNERABILITY #4: HTTP Response Splitting
// Hidden Hint: CRLF injection in headers
if(isset($_GET['redirect_to'])) {
    $location = $_GET['redirect_to'];
    // No sanitization - CRLF injection possible
    // Hidden Hint: ?redirect_to=test%0d%0aSet-Cookie:admin=true
    header("Location: " . $location);
    exit();
}

if(isset($_GET['log'])) {
    $log_msg = $_GET['log'];
    // VULNERABILITY: CRLF in log file
    // Hidden Hint: Can inject multiple log entries or XSS
    file_put_contents('logs.txt', $log_msg . "\n", FILE_APPEND);
}
?>
<!DOCTYPE html>
<html>
<head>
    <title>Advanced Exploits: SSTI, JWT, ReDoS</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-4">
        <h2>Advanced Vulnerability Testing</h2>
        
        <div class="row">
            <div class="col-md-6">
                <!-- SSTI -->
                <div class="card mb-3">
                    <div class="card-header bg-danger text-white">SSTI - Template Injection</div>
                    <div class="card-body">
                        <form method="post">
                            <input type="text" name="patient_name" placeholder="Patient Name" class="form-control mb-2">
                            <input type="text" name="diagnosis" placeholder="Diagnosis" class="form-control mb-2">
                            <button name="generate_report" class="btn btn-danger">Generate Report</button>
                            <small class="d-block mt-2">Try: {{7*7}} or {{system('whoami')}}</small>
                        </form>
                    </div>
                </div>

                <!-- JWT -->
                <div class="card mb-3">
                    <div class="card-header bg-warning">JWT Vulnerabilities</div>
                    <div class="card-body">
                        <form method="post">
                            <input type="text" name="user_id" value="1" class="form-control mb-2">
                            <input type="text" name="role" value="admin" class="form-control mb-2">
                            <button name="create_token" class="btn btn-warning">Create JWT</button>
                            <small class="d-block mt-2">Secret: secret123 (brute-forceable)</small>
                        </form>
                        
                        <form method="post" class="mt-3">
                            <input type="text" name="token" placeholder="JWT Token" class="form-control mb-2">
                            <button name="verify_token" class="btn btn-secondary">Verify</button>
                            <small class="d-block mt-2">Try: Replace alg with "none"</small>
                        </form>
                    </div>
                </div>

                <!-- ReDoS -->
                <div class="card mb-3">
                    <div class="card-header bg-info text-white">ReDoS - Regex DoS</div>
                    <div class="card-body">
                        <form method="post">
                            <input type="text" name="input" placeholder="Test Input" class="form-control mb-2">
                            <button name="validate_input" class="btn btn-info">Validate</button>
                            <small class="d-block mt-2">Try: aaaaaaaaaaaaaaaaaaaX (20+ a's then X)</small>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header">Output / Results</div>
                    <div class="card-body">
                        <?php if($output): ?>
                            <pre><?php echo htmlspecialchars($output); ?></pre>
                        <?php else: ?>
                            <p class="text-muted">No output yet</p>
                        <?php endif; ?>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">TIP: Exploitation Guides</div>
                    <div class="card-body small">
                        <p><strong>SSTI Payloads:</strong></p>
                        <pre>{{7*7}}
{{system('cat /etc/passwd')}}
{{phpinfo()}}
{{file_get_contents('/etc/passwd')}}</pre>

                        <p><strong>JWT None Algorithm:</strong></p>
                        <pre>1. Decode JWT
2. Change alg to "none"
3. Remove signature
4. Encode and send</pre>

                        <p><strong>ReDoS Pattern:</strong></p>
                        <pre>Regex: ^(a+)+$
Input: aaaaaaaaaa...aX
Result: Exponential time complexity</pre>

                        <p><strong>HTTP Response Splitting:</strong></p>
                        <pre>?redirect_to=test%0d%0aSet-Cookie:admin=true
?log=User login%0d%0aADMIN ACCESS%0d%0a</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
